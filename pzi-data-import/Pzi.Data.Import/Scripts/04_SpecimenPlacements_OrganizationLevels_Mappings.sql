-- Update OrganizationLevelId in SpecimenPlacements based on RegionId -> OrganizationLevelId mapping and Placements table

DECLARE @Mapping TABLE (
    RegionId INT,
    OrganizationLevelId INT
);

INSERT INTO @Mapping
VALUES
        (61, 1057),
        (143, 1057),
        (142, 1057),
        (149, 1057),
        (57, 9),
        (7, 9),
        (114, 9),
        (36, 9),
        (112, 9),
        (122, 9),
        (110, 9),
        (38, 9),
        (59, 9),
        (135, 9),
        (120, 9),
        (141, 9),
        (111, 9),
        (87, 9),
        (67, 9),
        (91, 9),
        (98, 9),
        (44, 9),
        (92, 9),
        (82, 9),
        (107, 9),
        (27, 1041),
        (77, 1014),
        (146, 1003),
        (147, 1003),
        (21, 1001),
        (100, 1),
        (108, 1062),
        (70, 1059),
        (86, 1010),
        (66, 1058),
        (109, 1057),
        (140, 1057),
        (81, 1058),
        (69, 1016),
        (132, 1016),
        (133, 1016),
        (85, 1016),
        (22, 1012),
        (68, 1012),
        (139, 1002),
        (23, 1016),
        (64, 1014),
        (65, 1067),
        (47, 1008),
        (25, 1011),
        (39, 1009),
        (74, 1061),
        (40, 1024),
        (145, 1027),
        (101, 2),
        (156, 1023),
        (93, 1019),
        (84, 1017),
        (155, 1021),
        (8, 1020),
        (99, 1019),
        (104, 1021),
        (10, 1024),
        (131, 1021),
        (46, 1024),
        (12, 1023),
        (9, 1017),
        (53, 1019),
        (119, 1026),
        (6, 2),
        (72, 1023),
        (80, 1052),
        (129, 2),
        (52, 1019),
        (11, 1021),
        (134, 2),
        (138, 1018),
        (6, 1020),
        (42, 1032),
        (13, 109),
        (123, 1032),
        (20, 1032),
        (14, 1032),
        (51, 1032),
        (18, 1036),
        (102, 3),
        (150, 1036),
        (137, 1033),
        (45, 1038),
        (16, 1039),
        (43, 1038),
        (136, 1038),
        (49, 1038),
        (15, 1034),
        (41, 1035),
        (17, 1036),
        (50, 1038),
        (60, 1030),
        (88, 3),
        (19, 1038),
        (4, 1045),
        (116, 1045),
        (113, 1045),
        (58, 1046),
        (103, 4),
        (106, 1044),
        (121, 1044),
        (154, 1042),
        (117, 4),
        (95, 1044),
        (157, 1043),
        (153, 1043),
        (94, 1043),
        (63, 1043),
        (126, 1043),
        (71, 1043),
        (30, 1044),
        (76, 1044),
        (118, 1044),
        (90, 1044),
        (29, 1044),
        (55, 1044),
        (127, 1044),
        (128, 1044),
        (5, 1044),
        (62, 1044),
        (54, 1044),
        (115, 1044),
        (130, 1044),
        (125, 114),
        (151, 1048),
        (158, 1048),
        (32, 1049),
        (144, 1049),
        (75, 1051),
        (78, 1050),
        (89, 1050),
        (148, 1050),
        (96, 1050),
        (11, 1050),
        (11, 1050),
        (73, 1054),
        (37, 1053),
        (28, 1052),
        (124, 1052),
        (79, 1056),
        (105, 116),
        (34, 1055),
        (26, 1057);

-- During import both SpecimenPlacements and Placements tables are copy of same source table so we can use join with id.
UPDATE sp
SET sp.OrganizationLevelId = m.OrganizationLevelId
FROM SpecimenPlacements sp
  INNER JOIN Placements p ON sp.Id = p.Id
  INNER JOIN @Mapping m ON p.RegionId = m.RegionId
WHERE m.OrganizationLevelId IS NOT NULL;

;WITH LatestPlacement AS (
  SELECT 
      p.SpecimenId,
      p.OrganizationLevelId,
      o.RegionId,
      ROW_NUMBER() OVER (PARTITION BY p.SpecimenId ORDER BY p.ValidSince DESC) AS rn
  FROM SpecimenPlacements p
    INNER JOIN Placements o ON p.Id = o.Id
)
UPDATE sp
SET sp.OrganizationLevelId = lp.OrganizationLevelId, sp.RegionId = lp.RegionId
FROM Specimens sp
  JOIN LatestPlacement lp ON sp.Id = lp.SpecimenId
WHERE lp.rn = 1;
